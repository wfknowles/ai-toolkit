# Brain Component Definitions, Requirements, and Guidelines

This document outlines the specifications for the core components of the file-based AI agent brain, as determined by the meeting of the minds on 2024-04-25 (Simulated).

## 1. Core Components & Definitions

### 1.1. YAML Frontmatter Schema

*   **Purpose:** To embed structured metadata within Markdown knowledge files for indexing and retrieval.
*   **Location:** At the very beginning of Markdown files in the `knowledge/` directory, enclosed by `---`.
*   **Format:** Standard YAML.
*   **Fields:**
    *   `title` (string, **Mandatory**): The main title of the document.
    *   `keywords` (list of strings, **Mandatory**): List of relevant keywords for lookup.
    *   `topics` (list of strings, **Mandatory**): List of broader topics the document belongs to.
    *   `uuid` (string, Optional): A unique identifier for the document.
    *   `created_at` (string - ISO 8601 Format, Optional): Creation timestamp.
    *   `updated_at` (string - ISO 8601 Format, Optional): Last modification timestamp.
    *   `summary` (string, Optional): A brief one-sentence summary of the document.
*   **Example:**
    ```yaml
    ---
    title: "Using the Retrieval Module"
    keywords: ["retrieval", "search", "index", "api"]
    topics: ["agent_core", "knowledge_management"]
    uuid: "b2c3d4e5-f6a7-8901-2345-67890abcdef1"
    created_at: "2024-04-25T10:00:00Z"
    summary: "Explains how to use the RetrievalModule class to query the brain index."
    ---
    
    Document content starts here...
    ```
*   **Requirements:** All `.md` files in `knowledge/` MUST contain valid YAML frontmatter with mandatory fields.
*   **Acceptance Criteria:** Indexer script correctly parses frontmatter from valid files; Indexer logs errors and skips files with invalid/missing frontmatter.
*   **Guidelines:** Keep keywords and topics focused and relevant. Use ISO 8601 for dates.

### 1.2. Master Index File (`master_index.json`)

*   **Purpose:** To provide a centralized, quickly loadable map for metadata-based lookups.
*   **Location:** `brain/index/master_index.json`
*   **Format:** JSON
*   **Schema:**
    ```json
    {
      "metadata": {
        "<file_path_relative_to_brain>": {
          "title": "...",
          "keywords": [...],
          "topics": [...],
          "uuid": "...", // Optional
          "created_at": "...", // Optional
          "updated_at": "...", // Optional
          "summary": "..." // Optional
        },
        // ... other files
      },
      "keyword_index": {
        "<keyword_lowercase>": [
          "<file_path_relative_to_brain>", 
          ...
        ],
        // ... other keywords
      },
      "topic_index": {
        "<topic_lowercase>": [
          "<file_path_relative_to_brain>",
          ...
        ],
        // ... other topics
      },
      // --- Optional Semantic Search Enhancement ---
      "embedding_index_file": "brain/index/embeddings.faiss", // Path relative to workspace root
      "embedding_map_file": "brain/index/embedding_map.json" // Path relative to workspace root
    }
    ```
*   **Requirements:** Must be generated by the indexer script. Must conform to the schema. Must be updated atomically.
*   **Acceptance Criteria:** Indexer generates a file matching this schema. Retrieval module can load and parse this file correctly.
*   **Guidelines:** File paths stored should be relative to the `brain/` directory for portability.

### 1.3. Indexer Script (`indexer.py`)

*   **Purpose:** To scan source directories, parse metadata, build the index file(s), and optionally generate embeddings.
*   **Location:** TBD (e.g., `scripts/indexer.py`)
*   **Execution:** Command Line Interface (CLI)
*   **CLI Specification:**
    `python indexer.py --source-dir <path> --index-dir <path> [--embeddings] [--log-level <level>] [--force-reindex]`
    *   `--source-dir`: Path to the directory to scan (e.g., `brain/knowledge`). (Required)
    *   `--index-dir`: Path to the output directory for index files (e.g., `brain/index`). (Required)
    *   `--embeddings`: Flag to enable embedding generation and semantic indexing. (Optional, Default: False)
    *   `--log-level`: Set logging level (e.g., DEBUG, INFO, WARNING). (Optional, Default: INFO)
    *   `--force-reindex`: Flag to force re-indexing of all files, ignoring timestamps/cache. (Optional, Default: False - implement timestamp checking later)
*   **Requirements:** Must implement CLI as specified. Must parse YAML frontmatter. Must generate `master_index.json`. Must perform atomic write for the index file. Must handle file read/parse errors gracefully (log and skip). Optionally implement embedding generation (`--embeddings`).
*   **Acceptance Criteria:** Script runs via CLI. Generates correct `master_index.json`. Handles missing/invalid frontmatter. Atomic write prevents corrupted index during run. `--embeddings` flag triggers embedding workflow (if implemented).
*   **Guidelines:** Use standard Python libraries (`os`, `json`, `yaml`, `argparse`, `logging`, `shutil`, `tempfile`). Implement basic logging. Consider adding timestamp checking later to only re-index changed files (unless `--force-reindex`).

### 1.4. Retrieval Module (`retrieval_module.py`)

*   **Purpose:** Provides an API for the agent core logic to query the brain's index.
*   **Location:** TBD (e.g., `agent_core/retrieval_module.py`)
*   **Usage:** Imported as a Python class.
*   **Class Specification:** `RetrievalModule`
    *   `__init__(self, index_dir: str)`: Initializes the module, loads the `master_index.json` from the specified directory into memory (with caching).
    *   `search_metadata(self, query: str, search_fields: list = ['title', 'keywords', 'topics', 'summary']) -> list[dict]`: Performs case-insensitive text search within the specified metadata fields for all files. Returns a list of full metadata dictionaries for matching files.
    *   `lookup_by_keyword(self, keyword: str) -> list[str]`: Returns list of file paths associated with the exact (case-insensitive) keyword.
    *   `lookup_by_topic(self, topic: str) -> list[str]`: Returns list of file paths associated with the exact (case-insensitive) topic.
    *   `find_similar(self, query_text: str, k: int = 5) -> list[tuple[str, int, float]]`: (Requires embeddings enabled during indexing). Embeds the `query_text`, searches the Faiss index, and returns a list of `(file_path, chunk_id, score)` tuples for the top `k` most similar chunks.
*   **Requirements:** Must implement the class and methods as specified. Must load the index efficiently (on init). Must handle index file not found errors. `find_similar` requires corresponding index files generated by indexer (`--embeddings`).
*   **Acceptance Criteria:** Module can be initialized. Metadata search methods return correct results based on the index. `find_similar` returns plausible results (if embeddings implemented). Handles missing index file gracefully.
*   **Guidelines:** Implement in-memory caching of the loaded index. Use type hinting. Add docstrings. Include basic error handling (e.g., for missing index, invalid query types). Use efficient search logic for `search_metadata`.

### 1.5. Semantic Search Components (Optional Enhancement)

*   **Purpose:** To enable searching based on semantic meaning rather than just keywords.
*   **Assets:**
    *   Embedding Model: e.g., `sentence-transformers/all-MiniLM-L6-v2`.
    *   Faiss Index: `brain/index/embeddings.faiss` (generated by indexer).
    *   Embedding Map: `brain/index/embedding_map.json` (maps Faiss index row ID to `{'file_path': str, 'chunk_id': int}`).
*   **Chunking Strategy:** Split Markdown files by paragraph (`\n\n`). Each paragraph is a chunk.
*   **Requirements:** Indexer (`--embeddings` flag) must generate embeddings, Faiss index, and map file. RetrievalModule's `find_similar` must load these and perform the search.
*   **Acceptance Criteria:** Indexer generates `.faiss` and `embedding_map.json` files. `find_similar` returns relevant results for semantic queries.
*   **Guidelines:** Pin the `sentence-transformers` and `faiss-cpu` versions in `requirements.txt`. Start with `IndexFlatL2` in Faiss for simplicity.

## 2. General Requirements & Guidelines

*   **R1: Initial Implementation Scope:** Focus on implementing the non-embedding features first: YAML Frontmatter enforcement, Indexer script (metadata only), `master_index.json`, Retrieval Module (metadata search methods).
*   **R2: Semantic Search:** Implement semantic search components as a secondary step.
*   **G1: Dependencies:** Use `requirements.txt` to manage Python dependencies (e.g., `PyYAML`, `numpy`, `sentence-transformers`, `faiss-cpu`). Pin versions.
*   **G2: Testing:** Implement unit tests (`pytest`) for core logic (parsing, index generation, retrieval methods, atomic write). Aim for reasonable coverage.
*   **G3: Documentation:** Add docstrings to public classes and functions. Include README files for the indexer script and retrieval module explaining usage.
*   **G4: Coding Standards:** Follow PEP 8 style guide. Use type hinting.
*   **G5: Logging:** Implement structured logging (Python `logging` module) in the indexer and retrieval module to aid debugging.
*   **G6: Error Handling:** Implement robust error handling for file operations, parsing, and potential runtime issues.
*   **G7: Configuration:** Externalize configuration (e.g., embedding model name, default log level) if needed later (e.g., via `configuration.json` or environment variables). 